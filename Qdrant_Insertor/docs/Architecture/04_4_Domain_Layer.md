# 4.4 领域层（接口 & 策略）

## 2.1 概述

领域层是系统的核心业务规则所在层，它包含了所有与业务逻辑相关的实体、值对象、聚合、领域服务、仓储接口和领域事件。本层不依赖任何外部框架或数据库实现，保持业务逻辑的纯粹性和独立性，以便于测试和维护。

## 2.2 模块列表

*   **Retriever**
*   **FusionStrategy**
*   **GraphExtractor**
*   **GraphRepository Interface**
*   **DTOs with Zod**

## 2.3 模块详情

### 2.3.1 Retriever

#### 2.3.1.1 职责

*   **获取检索结果**：负责从 Qdrant 向量数据库和 SQLite 元数据存储中获取与查询相关的文本块（Chunks）或文档元数据。
*   **抽象检索逻辑**：封装了底层数据存储的细节，向上层提供统一的检索接口。

#### 2.3.1.2 接口与数据流

*   **对外接口**：由 `SearchService` 调用，接收查询参数和过滤条件。
*   **对内接口**：
    *   调用 `QdrantRepo` 进行向量相似度搜索。
    *   调用 `SQLiteRepo` 进行关键词搜索和元数据查询。
*   **数据流**：SearchService -> Retriever -> QdrantRepo / SQLiteRepo -> Retriever -> SearchService。

#### 2.3.1.3 关键实现与技术栈

*   **检索算法**：实现关键词搜索（FTS5）和语义搜索的协调逻辑。
*   **数据聚合**：将从不同数据源获取的结果进行初步聚合。

#### 2.3.1.4 开发需求与约定

*   **编码规范**：
    *   检索逻辑应清晰，易于理解和扩展。
    *   避免在 `Retriever` 中包含业务流程编排，专注于数据获取。
*   **错误处理**：
    *   捕获底层数据存储的异常，并转换为领域层友好的错误类型。
*   **测试策略**：
    *   对 `Retriever` 进行单元测试，验证其检索逻辑的正确性。
    *   使用 Mock 对象模拟 `QdrantRepo` 和 `SQLiteRepo`，隔离测试 `Retriever` 的行为。
*   **性能考量**：
    *   优化查询语句和索引使用，确保检索效率。
    *   考虑缓存机制以减少重复查询。

### 2.3.2 FusionStrategy

#### 2.3.2.1 职责

*   **融合多源结果**：将来自不同检索源（如向量检索结果、图谱检索结果等）的 `RetrievalResult` 进行融合，生成最终的排序结果。
*   **策略模式**：作为可插拔的策略，支持不同的融合算法（如 RRF）。

#### 2.3.2.2 接口与数据流

*   **对外接口**：由 `SearchService` 调用，接收多个 `RetrievalResult` 列表。
*   **对内接口**：无直接对内接口，主要进行内部计算。
*   **数据流**：SearchService -> FusionStrategy -> SearchService。

#### 2.3.2.3 关键实现与技术栈

*   **融合算法**：实现 RRF (Reciprocal Rank Fusion) 或其他自定义融合算法。
*   **可插拔设计**：通过接口定义，允许轻松替换不同的融合策略。

#### 2.3.2.4 开发需求与约定

*   **编码规范**：
    *   融合算法应清晰、可配置。
    *   遵循策略模式的设计原则。
*   **错误处理**：
    *   处理输入结果为空或格式不正确的情况。
*   **测试策略**：
    *   对 `FusionStrategy` 进行单元测试，验证不同融合算法在各种输入情况下的正确性。
*   **性能考量**：
    *   优化融合算法的计算效率，尤其是在结果列表较大时。

### 2.3.3 GraphExtractor

#### 2.3.3.1 职责

*   **从文本中提取实体关系**：分析原始文本内容，识别实体（Node）和它们之间的关系（Edge），构建 `GraphFragment`。
*   **知识图谱构建**：为知识图谱的构建提供基础数据。

#### 2.3.3.2 接口与数据流

*   **对外接口**：由 `GraphService` 调用，接收文本内容。
*   **对内接口**：无直接对内接口，可能依赖 NLP 工具库。
*   **数据流**：GraphService -> GraphExtractor -> GraphService。

#### 2.3.3.3 关键实现与技术栈

*   **NLP 技术**：可能使用自然语言处理 (NLP) 库或模型进行实体识别和关系抽取。
*   **规则引擎**：可能通过规则或模式匹配来提取特定类型的关系。

#### 2.3.3.4 开发需求与约定

*   **编码规范**：
    *   提取逻辑应可配置和扩展，以适应不同类型的文本和知识领域。
*   **错误处理**：
    *   处理文本解析失败或无法提取有效关系的情况。
*   **测试策略**：
    *   对 `GraphExtractor` 进行单元测试，验证其在不同文本输入下的实体关系提取准确性。
*   **性能考量**：
    *   优化文本处理和关系抽取算法的效率。

### 2.3.4 GraphRepository Interface

#### 2.3.4.1 职责

*   **定义图存储抽象接口**：为知识图谱的持久化操作提供抽象接口，不关心具体的存储实现。
*   **解耦领域层与基础设施层**：确保领域层不直接依赖于特定的图数据库技术。

#### 2.3.4.2 接口与数据流

*   **对外接口**：由 `GraphService` 调用，提供图的 CRUD 操作（如保存 `GraphFragment`、查询 `Node` 和 `Edge`）。
*   **对内接口**：无直接对内接口，由基础设施层的具体实现来完成。
*   **数据流**：GraphService -> GraphRepository Interface -> Infrastructure Layer (GraphRepo Impl.)。

#### 2.3.4.3 关键实现与技术栈

*   **接口定义**：使用 TypeScript 接口定义图存储的契约。

#### 2.3.4.4 开发需求与约定

*   **编码规范**：
    *   接口定义应清晰、稳定，反映领域模型的概念。
*   **错误处理**：
    *   接口方法应定义可能抛出的异常类型。
*   **测试策略**：
    *   对接口定义本身无需测试，但其实现类需要进行集成测试。
*   **可扩展性**：
    *   接口应易于扩展，以支持未来可能引入的更复杂的图操作。

### 2.3.5 DTOs with Zod

#### 2.3.5.1 职责

*   **共享的数据传输对象**：定义在不同层级之间传输数据的结构。
*   **验证模式**：结合 Zod 提供数据校验能力，确保数据格式和内容的正确性。
*   **统一数据契约**：作为 API 层、应用层和领域层之间的数据契约。

#### 2.3.5.2 接口与数据流

*   **对外接口**：作为数据结构在各层之间传递。
*   **对内接口**：无。
*   **数据流**：API Layer <-> Application Layer <-> Domain Layer。

#### 2.3.5.3 关键实现与技术栈

*   **技术栈**：Zod。
*   **类型定义**：使用 TypeScript 类型定义 DTO。

#### 2.3.5.4 开发需求与约定

*   **编码规范**：
    *   DTO 命名应清晰，反映其用途。
    *   Zod Schema 应与 DTO 类型保持一致，并包含详细的校验规则。
    *   DTO 应保持扁平化，避免过度嵌套。
*   **错误处理**：
    *   Zod 校验失败时，应返回详细的错误信息。
*   **测试策略**：
    *   对 Zod Schema 进行单元测试，验证其校验逻辑的正确性。
*   **版本管理**：
    *   DTO 的变更应谨慎，并考虑对上下游的影响。