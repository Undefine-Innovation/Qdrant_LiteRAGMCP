# 4.3 åº”ç”¨å±‚

## 2.1 æ¦‚è¿°

åº”ç”¨å±‚è´Ÿè´£åè°ƒä¸šåŠ¡æµç¨‹ï¼Œå°è£…å’Œç¼–æ’é¢†åŸŸå±‚çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½†ä¸åŒ…å«å…·ä½“çš„ä¸šåŠ¡è§„åˆ™å®ç°ã€‚å®ƒä½œä¸º API å±‚å’Œé¢†åŸŸå±‚ä¹‹é—´çš„æ¡¥æ¢ï¼Œå¤„ç†è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæµç¨‹çš„æ­£ç¡®æ€§ã€‚

## 2.2 æ¨¡å—åˆ—è¡¨

- **ImportService**
- **SearchService**
- **GraphService**
- **CollectionService**
- **DocumentService**
- **BatchService**
- **FileProcessingService**
- **SyncStateMachine**
- **AutoGC**

## 2.3 æ¨¡å—è¯¦æƒ…

### 2.3.1 ImportService

#### 2.3.1.1 èŒè´£

- **æ–‡ä»¶å¯¼å…¥å…¨æµç¨‹ç®¡ç†**ï¼šåè°ƒæ–‡ä»¶åŠ è½½ã€æ–‡æœ¬åˆ‡ç‰‡ã€å‘é‡ç”Ÿæˆå’Œæ•°æ®å…¥åº“ï¼ˆQdrant å’Œ SQLiteï¼‰çš„æ•´ä¸ªæµç¨‹ã€‚
- **è§¦å‘åŒæ­¥çŠ¶æ€æœº**ï¼šåœ¨æ–‡ä»¶å¯¼å…¥å®Œæˆåï¼Œè§¦å‘ `SyncStateMachine` ä»¥ç¡®ä¿å‘é‡æ•°æ®åº“å’Œå…ƒæ•°æ®å­˜å‚¨çš„ä¸€è‡´æ€§ã€‚
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ–‡ä»¶å¯¼å…¥è¿‡ç¨‹ä¸­çš„å…³é”®æ­¥éª¤å’Œæ½œåœ¨é”™è¯¯ã€‚

#### 2.3.1.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± API å±‚è°ƒç”¨ï¼Œæ¥æ”¶æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - è°ƒç”¨ `FileLoader` åŠ è½½æ–‡ä»¶ã€‚
  - è°ƒç”¨ `Splitter` åˆ‡ç‰‡æ–‡æœ¬ã€‚
  - è°ƒç”¨ `Embedder` ç”Ÿæˆå‘é‡ã€‚
  - è°ƒç”¨ `QdrantRepo` å†™å…¥å‘é‡ã€‚
  - è°ƒç”¨ `SQLiteRepo` å†™å…¥å…ƒæ•°æ®ã€‚
  - è°ƒç”¨ `SyncStateMachine` è§¦å‘åŒæ­¥ã€‚
  - è°ƒç”¨ `Winston Logger` è®°å½•æ—¥å¿—ã€‚
- **æ•°æ®æµ**ï¼šAPI Layer -> ImportService -> FileLoader -> Splitter -> Embedder -> QdrantRepo / SQLiteRepo -> SyncStateMachineã€‚

#### 2.3.1.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **æµç¨‹ç¼–æ’**ï¼šé€šè¿‡åè°ƒåŸºç¡€è®¾æ–½å±‚å’Œé¢†åŸŸå±‚çš„ç»„ä»¶æ¥å®Œæˆå¤æ‚çš„æ–‡ä»¶å¯¼å…¥æµç¨‹ã€‚
- **äº‹åŠ¡ç®¡ç†**ï¼šå¯èƒ½éœ€è¦ç¡®ä¿æ–‡ä»¶å¯¼å…¥è¿‡ç¨‹ä¸­çš„å¤šä¸ªæ•°æ®æ“ä½œå…·æœ‰åŸå­æ€§ã€‚

#### 2.3.1.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - ä¿æŒä¸šåŠ¡æµç¨‹çš„æ¸…æ™°æ€§ï¼Œé¿å…åœ¨ Service ä¸­å®ç°å¤æ‚çš„åº•å±‚é€»è¾‘ã€‚
  - æ³¨é‡é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ–‡ä»¶å¯¼å…¥çš„å¥å£®æ€§ã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - æ•è·åº•å±‚æ¨¡å—æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯ä¸ŠæŠ¥ã€‚
  - åœ¨æ–‡ä»¶å¯¼å…¥å¤±è´¥æ—¶ï¼Œåº”æœ‰æ˜ç¡®çš„å›æ»šæˆ–æ¸…ç†æœºåˆ¶ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `ImportService` è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´æµç¨‹ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®å…¥åº“å’ŒåŒæ­¥çŠ¶æ€æœºæ˜¯å¦è¢«è§¦å‘ã€‚
  - ä½¿ç”¨ Mock å¯¹è±¡æ¨¡æ‹Ÿåº•å±‚ä¾èµ–ï¼Œéš”ç¦»æµ‹è¯• `ImportService` çš„æµç¨‹ç¼–æ’é€»è¾‘ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - å¤„ç†å¤§æ–‡ä»¶æ—¶ï¼Œè€ƒè™‘åˆ†å—å¤„ç†å’Œå¼‚æ­¥æ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
  - ä¼˜åŒ–æ•°æ®åº“å†™å…¥å’Œå‘é‡ç”Ÿæˆæ“ä½œçš„æ€§èƒ½ã€‚

### 2.3.2 SearchService

#### 2.3.2.1 èŒè´£

- **å°è£…æ£€ç´¢é€»è¾‘è°ƒç”¨**ï¼šåè°ƒ `Retriever` å’Œ `FusionStrategy`ï¼Œå®Œæˆæ–‡æ¡£æ£€ç´¢åŠŸèƒ½ã€‚
- **ç»“æœå¤„ç†**ï¼šå¯¹æ£€ç´¢ç»“æœè¿›è¡Œåˆæ­¥å¤„ç†å’Œæ ¼å¼åŒ–ï¼Œè¿”å›ç»™ API å±‚ã€‚
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æœç´¢è¯·æ±‚å’Œç»“æœã€‚

#### 2.3.2.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± API å±‚è°ƒç”¨ï¼Œæ¥æ”¶æœç´¢æŸ¥è¯¢å’Œè¿‡æ»¤æ¡ä»¶ã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - è°ƒç”¨ `Retriever` è¿›è¡Œå‘é‡æ£€ç´¢ã€‚
  - è°ƒç”¨ `FusionStrategy` èåˆå¤šæºç»“æœã€‚
  - è°ƒç”¨ `Winston Logger` è®°å½•æ—¥å¿—ã€‚
- **æ•°æ®æµ**ï¼šAPI Layer -> SearchService -> Retriever -> FusionStrategy -> SearchService -> API Layerã€‚

#### 2.3.2.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **æµç¨‹ç¼–æ’**ï¼šåè°ƒæ£€ç´¢å’Œç»“æœèåˆçš„æ­¥éª¤ã€‚

#### 2.3.2.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - ä¿æŒæœç´¢é€»è¾‘çš„æ¸…æ™°æ€§ï¼Œå°†å¤æ‚çš„æ£€ç´¢ç®—æ³•å§”æ‰˜ç»™é¢†åŸŸå±‚ã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - æ•è·åº•å±‚æ£€ç´¢æ¨¡å—çš„å¼‚å¸¸ï¼Œå¹¶è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `SearchService` è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæœç´¢è¯·æ±‚ï¼ŒéªŒè¯æ£€ç´¢ç»“æœçš„æ­£ç¡®æ€§å’Œèåˆç­–ç•¥çš„æœ‰æ•ˆæ€§ã€‚
  - ä½¿ç”¨ Mock å¯¹è±¡æ¨¡æ‹Ÿ `Retriever` å’Œ `FusionStrategy`ï¼Œéš”ç¦»æµ‹è¯• `SearchService` çš„åè°ƒé€»è¾‘ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - ä¼˜åŒ–æ£€ç´¢è¯·æ±‚çš„å“åº”æ—¶é—´ï¼Œè€ƒè™‘ç¼“å­˜æœºåˆ¶ã€‚

### 2.3.3 CollectionService

#### 2.3.3.1 èŒè´£

- **Collection ç®¡ç†**ï¼šè´Ÿè´£ Collection çš„æ‰€æœ‰ CRUD æ“ä½œï¼ˆåˆ›å»ºã€åˆ—å‡ºã€è·å–ã€åˆ é™¤ï¼‰ã€‚
- **åè°ƒåŸºç¡€è®¾æ–½å±‚**ï¼šåè°ƒ `SQLiteRepo` æ¥è¿›è¡Œå®é™…çš„æ•°æ®åº“æ“ä½œã€‚

#### 2.3.3.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± API å±‚è°ƒç”¨ï¼Œæ¥æ”¶ Collection ç®¡ç†è¯·æ±‚ã€‚
- **å¯¹å†…æ¥å£**ï¼šè°ƒç”¨ `SQLiteRepo` è¿›è¡Œ Collection ç›¸å…³çš„æ•°æ®åº“æ“ä½œã€‚
- **æ•°æ®æµ**ï¼šAPI Layer -> CollectionService -> SQLiteRepoã€‚

#### 2.3.3.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **æµç¨‹ç¼–æ’**ï¼šåè°ƒ Collection çš„åˆ›å»ºã€æŸ¥è¯¢å’Œåˆ é™¤ã€‚

#### 2.3.3.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - ä¿æŒ Collection ç®¡ç†é€»è¾‘çš„æ¸…æ™°æ€§ã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - æ•è·åº•å±‚æ•°æ®åº“æ“ä½œçš„å¼‚å¸¸ï¼Œå¹¶è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `CollectionService` è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿ Collection çš„ CRUD æ“ä½œï¼ŒéªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å’Œå†™å…¥æ“ä½œçš„æ€§èƒ½ã€‚

### 2.3.4 DocumentService

#### 2.3.4.1 èŒè´£

- **Document ç®¡ç†**ï¼šè´Ÿè´£ Document çš„æ‰€æœ‰éå¯¼å…¥/åˆ é™¤ç›¸å…³çš„ CRUD æ“ä½œï¼ˆåˆ—å‡ºã€è·å–ã€æ›´æ–°ï¼‰ã€‚
- **åè°ƒåŸºç¡€è®¾æ–½å±‚å’Œ ImportService**ï¼šåè°ƒ `SQLiteRepo` è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œå¹¶è°ƒç”¨ `ImportService` çš„ `resyncDocument` æ–¹æ³•è¿›è¡Œæ–‡æ¡£é‡æ–°åŒæ­¥ã€‚

#### 2.3.4.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± API å±‚è°ƒç”¨ï¼Œæ¥æ”¶ Document ç®¡ç†è¯·æ±‚ã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - è°ƒç”¨ `SQLiteRepo` è¿›è¡Œ Document ç›¸å…³çš„æ•°æ®åº“æ“ä½œã€‚
  - è°ƒç”¨ `ImportService` è¿›è¡Œæ–‡æ¡£é‡æ–°åŒæ­¥ã€‚
- **æ•°æ®æµ**ï¼šAPI Layer -> DocumentService -> SQLiteRepo / ImportServiceã€‚

#### 2.3.4.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **æµç¨‹ç¼–æ’**ï¼šåè°ƒ Document çš„æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤ã€‚

#### 2.3.4.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - ä¿æŒ Document ç®¡ç†é€»è¾‘çš„æ¸…æ™°æ€§ã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - æ•è·åº•å±‚æ•°æ®åº“æ“ä½œæˆ– `ImportService` æŠ›å‡ºçš„å¼‚å¸¸ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `DocumentService` è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿ Document çš„ CRUD æ“ä½œï¼ŒéªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å’Œå†™å…¥æ“ä½œçš„æ€§èƒ½ã€‚

### 2.3.5 GraphService (é•¿æœŸç›®æ ‡)

#### 2.3.3.1 èŒè´£

- **æ„å»ºå’ŒæŸ¥è¯¢å›¾è°±ä¿¡æ¯**ï¼šåè°ƒ `GraphExtractor` å’Œ `GraphRepository Interface`ï¼Œå¤„ç†çŸ¥è¯†å›¾è°±çš„æ„å»ºå’ŒæŸ¥è¯¢ã€‚æ­¤æ¨¡å—ä¸ºæœªæ¥æ‰©å±•çŸ¥è¯†å›¾è°±èƒ½åŠ›é¢„ç•™ï¼Œå½“å‰å¯èƒ½å¤„äºè§„åˆ’æˆ–åˆæ­¥å®ç°é˜¶æ®µã€‚

#### 2.3.3.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± API å±‚è°ƒç”¨ï¼Œæ¥æ”¶å›¾è°±æ„å»ºæˆ–æŸ¥è¯¢è¯·æ±‚ã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - è°ƒç”¨ `GraphExtractor` ä»æ–‡æœ¬ä¸­æå–å®ä½“å…³ç³»ã€‚
  - è°ƒç”¨ `GraphRepository Interface` è¿›è¡Œå›¾å­˜å‚¨æ“ä½œã€‚
- **æ•°æ®æµ**ï¼šAPI Layer -> GraphService -> GraphExtractor / GraphRepository Interface -> GraphService -> API Layerã€‚

#### 2.3.3.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **æµç¨‹ç¼–æ’**ï¼šåè°ƒå›¾è°±çš„æå–å’Œå­˜å‚¨ã€‚

#### 2.3.3.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - ä¿æŒå›¾è°±æ“ä½œé€»è¾‘çš„æ¸…æ™°æ€§ã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - æ•è·åº•å±‚å›¾è°±æ¨¡å—çš„å¼‚å¸¸ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `GraphService` è¿›è¡Œé›†æˆæµ‹è¯•ï¼ŒéªŒè¯å›¾è°±æ„å»ºå’ŒæŸ¥è¯¢çš„æ­£ç¡®æ€§ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - ä¼˜åŒ–å›¾è°±æ„å»ºå’ŒæŸ¥è¯¢çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®ä¸‹ã€‚

### 2.3.4 SyncStateMachine

#### 2.3.4.1 èŒè´£

- **é©±åŠ¨å‘é‡ä¸å…ƒæ•°æ®åŒæ­¥æµç¨‹**ï¼šç¡®ä¿ Qdrant å‘é‡æ•°æ®åº“ä¸ SQLite å…ƒæ•°æ®å­˜å‚¨ä¹‹é—´çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚
- **çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†åŒæ­¥ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ–°å»ºã€åˆ‡ç‰‡å®Œæˆã€å‘é‡åµŒå…¥å®Œæˆã€åŒæ­¥å®Œæˆã€å¤±è´¥å’Œé‡è¯•ç­‰çŠ¶æ€ã€‚
- **æŒä¹…åŒ–**ï¼šå°†åŒæ­¥ä»»åŠ¡çš„çŠ¶æ€æŒä¹…åŒ–åˆ° `SyncJob` æ•°æ®è¡¨ä¸­ã€‚

#### 2.3.4.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šç”± `ImportService` è§¦å‘åŒæ­¥ä»»åŠ¡ã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - æ›´æ–° `SyncJob` æ•°æ®è¡¨ã€‚
  - è°ƒç”¨ `Winston Logger` è®°å½•æ—¥å¿—ã€‚
- **æ•°æ®æµ**ï¼šImportService -> SyncStateMachine -> SyncJob Tableã€‚

#### 2.3.4.3 å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… åŸºäºçŠ¶æ€è½¬æ¢è¡¨çš„çŠ¶æ€æœºå®ç° ([`SyncStateMachineCore`](packages/backend/src/application/SyncStateMachineCore.ts:13))
- âœ… 7ç§çŠ¶æ€å®šä¹‰ ([`SyncJobStatus`](packages/backend/src/domain/sync/types.ts:6))
- âœ… çŠ¶æ€æŒä¹…åŒ–åˆ°æ•°æ®åº“
- âœ… é”™è¯¯åˆ†ç±»å’Œé‡è¯•æœºåˆ¶ ([`ErrorClassifier`](packages/backend/src/domain/sync/ErrorClassifier.ts:14))
- âœ… æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ ([`RetryScheduler`](packages/backend/src/domain/sync/RetryScheduler.ts:22))

**æŠ€æœ¯å€ºåŠ¡**ï¼š
- âš ï¸ åŸºäºçŠ¶æ€è½¬æ¢è¡¨ï¼Œæ‰©å±•æ€§æœ‰é™
- âš ï¸ é”™è¯¯å¤„ç†åŸºäºè§„åˆ™åˆ†ç±»ï¼Œä¸å¤Ÿæ™ºèƒ½
- âš ï¸ çŠ¶æ€æœºé€»è¾‘é›†ä¸­ï¼Œéš¾ä»¥å¤ç”¨
- âš ï¸ ä¸æ”¯æŒä¸åŒç±»å‹å¼‚æ­¥ä»»åŠ¡çš„ç»Ÿä¸€ç®¡ç†

#### 2.3.4.4 ğŸ”„ è®¡åˆ’æ”¹è¿› (A2. ç­–ç•¥æ¨¡å¼çŠ¶æ€æœº + A3. é”™è¯¯å·¥å‚æ¨¡å¼)

**ç›®æ ‡**ï¼šä¸ºæ–‡æ¡£å¯¼å…¥ã€çˆ¬è™«ä»»åŠ¡ç­‰å¼‚æ­¥ä»»åŠ¡æä¾›ç»Ÿä¸€ã€å¯é çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```typescript
// åŸºç¡€çŠ¶æ€æœºå¼•æ“
export abstract class BaseStateMachineEngine<TState, TEvent> {
  protected strategies: Map<TState, StateStrategy<TState, TEvent>>;
  
  async processEvent(event: TEvent): Promise<TState> {
    const currentState = this.getCurrentState();
    const strategy = this.strategies.get(currentState);
    
    if (!strategy) {
      throw new Error(`No strategy found for state: ${currentState}`);
    }
    
    return await strategy.handleEvent(event, this.context);
  }
}

// æ–‡æ¡£å¯¼å…¥ç­–ç•¥
export class ImportJobStrategy implements StateStrategy<ImportState, ImportEvent> {
  async handleEvent(event: ImportEvent, context: ImportContext): Promise<ImportState> {
    switch (event.type) {
      case 'DOCUMENT_UPLOADED':
        return await this.handleDocumentUploaded(event, context);
      case 'CHUNKS_SAVED':
        return await this.handleChunksSaved(event, context);
      case 'EMBEDDING_COMPLETED':
        return await this.handleEmbeddingCompleted(event, context);
      case 'ERROR_OCCURRED':
        return await this.handleErrorOccurred(event, context);
      default:
        return context.currentState;
    }
  }
}

// é”™è¯¯å·¥å‚æ¨¡å¼
export class AppErrorFactory {
  static createError(originalError: Error, context: ErrorContext): AppError {
    if (this.isTransientError(originalError)) {
      return new TransientAppError(originalError, context);
    } else {
      return new PermanentAppError(originalError, context);
    }
  }
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. **åŸºç¡€å¼•æ“è®¾è®¡**ï¼šå®ç° `BaseStateMachineEngine` æŠ½è±¡ç±»
2. **ç­–ç•¥æ¥å£å®šä¹‰**ï¼šå®šä¹‰ `StateStrategy` æ¥å£å’Œé€šç”¨äº‹ä»¶ç±»å‹
3. **å…·ä½“ç­–ç•¥å®ç°**ï¼šå®ç° `ImportJobStrategy`ã€`ScrapeJobStrategy` ç­‰
4. **é”™è¯¯å·¥å‚å®ç°**ï¼šåˆ›å»º `AppErrorFactory` å’Œç»“æ„åŒ–é”™è¯¯ç±»å‹
5. **çŠ¶æ€æœºé‡æ„**ï¼šå°†ç°æœ‰çŠ¶æ€æœºè¿ç§»åˆ°ç­–ç•¥æ¨¡å¼

**é¢„æœŸæ”¶ç›Š**ï¼š
- æé«˜çŠ¶æ€æœºé€»è¾‘çš„å¯æ‰©å±•æ€§å’Œå¤ç”¨æ€§
- æ”¯æŒå¤šç§å¼‚æ­¥ä»»åŠ¡çš„ç»Ÿä¸€ç®¡ç†
- æ™ºèƒ½é”™è¯¯åˆ†ç±»å’Œé‡è¯•å†³ç­–
- æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œç»´æŠ¤æ€§

#### 2.3.4.5 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - æ¸…æ™°å®šä¹‰çŠ¶æ€æœºçš„çŠ¶æ€å’Œäº‹ä»¶ï¼Œç¡®ä¿çŠ¶æ€è½¬ç§»é€»è¾‘çš„æ­£ç¡®æ€§ã€‚
  - çŠ¶æ€æœºåº”å…·æœ‰å¯æ‰©å±•æ€§ï¼Œä¾¿äºæœªæ¥æ·»åŠ æ–°çš„çŠ¶æ€æˆ–äº‹ä»¶ã€‚
  - **ğŸ†• ç­–ç•¥æ¨¡å¼**ï¼šæ¯ä¸ªçŠ¶æ€ä¸€ä¸ªç­–ç•¥ç±»ï¼Œä¿æŒèŒè´£å•ä¸€
- **é”™è¯¯å¤„ç†**ï¼š
  - åœ¨çŠ¶æ€è½¬ç§»è¿‡ç¨‹ä¸­æ•è·å¼‚å¸¸ï¼Œå¹¶æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡ŒçŠ¶æ€å›æ»šæˆ–æ ‡è®°ä¸ºå¤±è´¥ã€‚
  - å®ç°é‡è¯•æœºåˆ¶ï¼Œå¤„ç†ä¸´æ—¶æ€§é”™è¯¯ã€‚
  - **ğŸ†• é”™è¯¯å·¥å‚**ï¼šä½¿ç”¨ç»“æ„åŒ–é”™è¯¯ç±»å‹ï¼Œæ”¯æŒæ™ºèƒ½å†³ç­–
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹çŠ¶æ€æœºè¿›è¡Œå•å…ƒæµ‹è¯•ï¼ŒéªŒè¯æ‰€æœ‰çŠ¶æ€è½¬ç§»è·¯å¾„å’Œäº‹ä»¶å¤„ç†çš„æ­£ç¡®æ€§ã€‚
  - é›†æˆæµ‹è¯•åº”éªŒè¯ `SyncJob` çŠ¶æ€åœ¨æ•°æ®åº“ä¸­çš„æŒä¹…åŒ–ã€‚
  - **ğŸ†• ç­–ç•¥æµ‹è¯•**ï¼šç‹¬ç«‹æµ‹è¯•æ¯ä¸ªçŠ¶æ€ç­–ç•¥çš„é€»è¾‘
- **æ€§èƒ½è€ƒé‡**ï¼š
  - ä¼˜åŒ–çŠ¶æ€æœºè½®è¯¢çš„é¢‘ç‡å’Œæ•ˆç‡ï¼Œé¿å…èµ„æºæµªè´¹ã€‚
  - **ğŸ†• å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¤šä¸ªçŠ¶æ€æœºå®ä¾‹å¹¶è¡Œè¿è¡Œ

### 2.3.5 AutoGC

#### 2.3.5.1 èŒè´£

- **å…œåº•ã€ä¿®è¡¥åŠæ¸…ç†å†å²åƒåœ¾**ï¼šè´Ÿè´£å®šæœŸæ‰«æ SQLite ä¸ Qdrant æ•°æ®ä¸€è‡´æ€§ï¼Œåˆ é™¤å­¤å„¿å‘é‡ä¸æ— å…³å…ƒæ•°æ®ã€‚
- **æ•°æ®ä¸€è‡´æ€§ç»´æŠ¤**ï¼šé‡‡ç”¨ **Level-2ï¼šåŒç«¯æ¯”å¯¹** ç­–ç•¥ï¼Œç»´æŠ¤ `chunk_checksum`ï¼ˆæˆ– row countï¼‰å¿«ç…§è¡¨ï¼Œå®šæœŸæ¯”å¯¹ä¸¤ç«¯æ•°æ®ã€‚

#### 2.3.5.2 æ¥å£ä¸æ•°æ®æµ

- **å¯¹å¤–æ¥å£**ï¼šæ— ç›´æ¥å¯¹å¤–æ¥å£ï¼Œä½œä¸ºåå°æœåŠ¡è‡ªåŠ¨è¿è¡Œã€‚
- **å¯¹å†…æ¥å£**ï¼š
  - è°ƒç”¨ `SQLiteRepo` æŸ¥è¯¢å…ƒæ•°æ®å’Œå¿«ç…§è¡¨ã€‚
  - è°ƒç”¨ `QdrantRepo` æŸ¥è¯¢å‘é‡æ•°æ®ã€‚
  - æ‰§è¡Œåˆ é™¤æ“ä½œä»¥æ¸…ç†ä¸ä¸€è‡´æ•°æ®ã€‚
- **æ•°æ®æµ**ï¼šåå°å®šæ—¶ä»»åŠ¡ -> AutoGC -> SQLiteRepo / QdrantRepoã€‚

#### 2.3.5.3 å…³é”®å®ç°ä¸æŠ€æœ¯æ ˆ

- **åŒç«¯æ¯”å¯¹**ï¼šå®ç° SQLite å’Œ Qdrant æ•°æ®çš„ä¸€è‡´æ€§æ£€æŸ¥é€»è¾‘ã€‚
- **å®šæ—¶ä»»åŠ¡**ï¼šä½¿ç”¨ `node-cron` æˆ–ç±»ä¼¼åº“å®ç°å®šæ—¶æ‰§è¡Œã€‚

#### 2.3.5.4 å¼€å‘éœ€æ±‚ä¸çº¦å®š

- **ç¼–ç è§„èŒƒ**ï¼š
  - æ¸…ç†é€»è¾‘åº”ä¸¥è°¨ï¼Œé¿å…è¯¯åˆ æ•°æ®ã€‚
  - æ—¥å¿—è®°å½•åº”è¯¦ç»†ï¼Œè®°å½•æ¯æ¬¡æ¸…ç†æ“ä½œçš„ç»“æœã€‚
- **é”™è¯¯å¤„ç†**ï¼š
  - åœ¨æ¸…ç†è¿‡ç¨‹ä¸­æ•è·å¼‚å¸¸ï¼Œå¹¶ç¡®ä¿æ¸…ç†æ“ä½œçš„å¹‚ç­‰æ€§ã€‚
- **æµ‹è¯•ç­–ç•¥**ï¼š
  - å¯¹ `AutoGC` è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯ï¼ŒéªŒè¯å…¶æ¸…ç†åŠŸèƒ½çš„æ­£ç¡®æ€§ã€‚
  - åœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯æ¸…ç†æ“ä½œä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡æ•°æ®ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼š
  - æ¸…ç†ä»»åŠ¡åº”åœ¨ç³»ç»Ÿä½å³°æœŸè¿è¡Œï¼Œé¿å…å¯¹æ­£å¸¸ä¸šåŠ¡é€ æˆå½±å“ã€‚
  - ä¼˜åŒ–æ•°æ®æ¯”å¯¹å’Œåˆ é™¤æ“ä½œçš„æ•ˆç‡ã€‚
