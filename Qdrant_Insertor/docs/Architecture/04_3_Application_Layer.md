# 4.3 应用层

## 2.1 概述

应用层负责协调业务流程，封装和编排领域层的核心逻辑，但不包含具体的业务规则实现。它作为 API 层和领域层之间的桥梁，处理请求的生命周期，并确保数据的一致性和流程的正确性。

## 2.2 模块列表

- **ImportService**
- **SearchService**
- **GraphService**
- **CollectionService**
- **DocumentService**
- **SyncStateMachine**
- **AutoGC**

## 2.3 模块详情

### 2.3.1 ImportService

#### 2.3.1.1 职责

- **文件导入全流程管理**：协调文件加载、文本切片、向量生成和数据入库（Qdrant 和 SQLite）的整个流程。
- **触发同步状态机**：在文件导入完成后，触发 `SyncStateMachine` 以确保向量数据库和元数据存储的一致性。
- **日志记录**：记录文件导入过程中的关键步骤和潜在错误。

#### 2.3.1.2 接口与数据流

- **对外接口**：由 API 层调用，接收文件上传请求。
- **对内接口**：
  - 调用 `FileLoader` 加载文件。
  - 调用 `Splitter` 切片文本。
  - 调用 `Embedder` 生成向量。
  - 调用 `QdrantRepo` 写入向量。
  - 调用 `SQLiteRepo` 写入元数据。
  - 调用 `SyncStateMachine` 触发同步。
  - 调用 `Winston Logger` 记录日志。
- **数据流**：API Layer -> ImportService -> FileLoader -> Splitter -> Embedder -> QdrantRepo / SQLiteRepo -> SyncStateMachine。

#### 2.3.1.3 关键实现与技术栈

- **流程编排**：通过协调基础设施层和领域层的组件来完成复杂的文件导入流程。
- **事务管理**：可能需要确保文件导入过程中的多个数据操作具有原子性。

#### 2.3.1.4 开发需求与约定

- **编码规范**：
  - 保持业务流程的清晰性，避免在 Service 中实现复杂的底层逻辑。
  - 注重错误处理和重试机制，确保文件导入的健壮性。
- **错误处理**：
  - 捕获底层模块抛出的异常，并进行适当的日志记录和错误上报。
  - 在文件导入失败时，应有明确的回滚或清理机制。
- **测试策略**：
  - 对 `ImportService` 进行集成测试，模拟文件上传的完整流程，验证数据是否正确入库和同步状态机是否被触发。
  - 使用 Mock 对象模拟底层依赖，隔离测试 `ImportService` 的流程编排逻辑。
- **性能考量**：
  - 处理大文件时，考虑分块处理和异步操作，避免阻塞主线程。
  - 优化数据库写入和向量生成操作的性能。

### 2.3.2 SearchService

#### 2.3.2.1 职责

- **封装检索逻辑调用**：协调 `Retriever` 和 `FusionStrategy`，完成文档检索功能。
- **结果处理**：对检索结果进行初步处理和格式化，返回给 API 层。
- **日志记录**：记录搜索请求和结果。

#### 2.3.2.2 接口与数据流

- **对外接口**：由 API 层调用，接收搜索查询和过滤条件。
- **对内接口**：
  - 调用 `Retriever` 进行向量检索。
  - 调用 `FusionStrategy` 融合多源结果。
  - 调用 `Winston Logger` 记录日志。
- **数据流**：API Layer -> SearchService -> Retriever -> FusionStrategy -> SearchService -> API Layer。

#### 2.3.2.3 关键实现与技术栈

- **流程编排**：协调检索和结果融合的步骤。

#### 2.3.2.4 开发需求与约定

- **编码规范**：
  - 保持搜索逻辑的清晰性，将复杂的检索算法委托给领域层。
- **错误处理**：
  - 捕获底层检索模块的异常，并返回友好的错误信息。
- **测试策略**：
  - 对 `SearchService` 进行集成测试，模拟搜索请求，验证检索结果的正确性和融合策略的有效性。
  - 使用 Mock 对象模拟 `Retriever` 和 `FusionStrategy`，隔离测试 `SearchService` 的协调逻辑。
- **性能考量**：
  - 优化检索请求的响应时间，考虑缓存机制。

### 2.3.3 CollectionService

#### 2.3.3.1 职责

- **Collection 管理**：负责 Collection 的所有 CRUD 操作（创建、列出、获取、删除）。
- **协调基础设施层**：协调 `SQLiteRepo` 来进行实际的数据库操作。

#### 2.3.3.2 接口与数据流

- **对外接口**：由 API 层调用，接收 Collection 管理请求。
- **对内接口**：调用 `SQLiteRepo` 进行 Collection 相关的数据库操作。
- **数据流**：API Layer -> CollectionService -> SQLiteRepo。

#### 2.3.3.3 关键实现与技术栈

- **流程编排**：协调 Collection 的创建、查询和删除。

#### 2.3.3.4 开发需求与约定

- **编码规范**：
  - 保持 Collection 管理逻辑的清晰性。
- **错误处理**：
  - 捕获底层数据库操作的异常，并返回友好的错误信息。
- **测试策略**：
  - 对 `CollectionService` 进行集成测试，模拟 Collection 的 CRUD 操作，验证数据是否正确。
- **性能考量**：
  - 优化数据库查询和写入操作的性能。

### 2.3.4 DocumentService

#### 2.3.4.1 职责

- **Document 管理**：负责 Document 的所有非导入/删除相关的 CRUD 操作（列出、获取、更新）。
- **协调基础设施层和 ImportService**：协调 `SQLiteRepo` 进行数据库操作，并调用 `ImportService` 的 `resyncDocument` 方法进行文档重新同步。

#### 2.3.4.2 接口与数据流

- **对外接口**：由 API 层调用，接收 Document 管理请求。
- **对内接口**：
  - 调用 `SQLiteRepo` 进行 Document 相关的数据库操作。
  - 调用 `ImportService` 进行文档重新同步。
- **数据流**：API Layer -> DocumentService -> SQLiteRepo / ImportService。

#### 2.3.4.3 关键实现与技术栈

- **流程编排**：协调 Document 的查询、更新和删除。

#### 2.3.4.4 开发需求与约定

- **编码规范**：
  - 保持 Document 管理逻辑的清晰性。
- **错误处理**：
  - 捕获底层数据库操作或 `ImportService` 抛出的异常。
- **测试策略**：
  - 对 `DocumentService` 进行集成测试，模拟 Document 的 CRUD 操作，验证数据是否正确。
- **性能考量**：
  - 优化数据库查询和写入操作的性能。

### 2.3.5 GraphService (长期目标)

#### 2.3.3.1 职责

- **构建和查询图谱信息**：协调 `GraphExtractor` 和 `GraphRepository Interface`，处理知识图谱的构建和查询。此模块为未来扩展知识图谱能力预留，当前可能处于规划或初步实现阶段。

#### 2.3.3.2 接口与数据流

- **对外接口**：由 API 层调用，接收图谱构建或查询请求。
- **对内接口**：
  - 调用 `GraphExtractor` 从文本中提取实体关系。
  - 调用 `GraphRepository Interface` 进行图存储操作。
- **数据流**：API Layer -> GraphService -> GraphExtractor / GraphRepository Interface -> GraphService -> API Layer。

#### 2.3.3.3 关键实现与技术栈

- **流程编排**：协调图谱的提取和存储。

#### 2.3.3.4 开发需求与约定

- **编码规范**：
  - 保持图谱操作逻辑的清晰性。
- **错误处理**：
  - 捕获底层图谱模块的异常。
- **测试策略**：
  - 对 `GraphService` 进行集成测试，验证图谱构建和查询的正确性。
- **性能考量**：
  - 优化图谱构建和查询的性能，尤其是在大规模数据下。

### 2.3.4 SyncStateMachine

#### 2.3.4.1 职责

- **驱动向量与元数据同步流程**：确保 Qdrant 向量数据库与 SQLite 元数据存储之间的数据最终一致性。
- **状态管理**：管理同步任务的生命周期，包括新建、切片完成、向量嵌入完成、同步完成、失败和重试等状态。
- **持久化**：将同步任务的状态持久化到 `SyncJob` 数据表中。

#### 2.3.4.2 接口与数据流

- **对外接口**：由 `ImportService` 触发同步任务。
- **对内接口**：
  - 更新 `SyncJob` 数据表。
  - 调用 `Winston Logger` 记录日志。
- **数据流**：ImportService -> SyncStateMachine -> SyncJob Table。

#### 2.3.4.3 关键实现与技术栈

- **状态机**：借助 `xstate` 定义状态转移逻辑。
- **异步任务**：通过异步任务轮询驱动状态演进。

#### 2.3.4.4 开发需求与约定

- **编码规范**：
  - 清晰定义状态机的状态和事件，确保状态转移逻辑的正确性。
  - 状态机应具有可扩展性，便于未来添加新的状态或事件。
- **错误处理**：
  - 在状态转移过程中捕获异常，并根据错误类型进行状态回滚或标记为失败。
  - 实现重试机制，处理临时性错误。
- **测试策略**：
  - 对状态机进行单元测试，验证所有状态转移路径和事件处理的正确性。
  - 集成测试应验证 `SyncJob` 状态在数据库中的持久化。
- **性能考量**：
  - 优化状态机轮询的频率和效率，避免资源浪费。

### 2.3.5 AutoGC

#### 2.3.5.1 职责

- **兜底、修补及清理历史垃圾**：负责定期扫描 SQLite 与 Qdrant 数据一致性，删除孤儿向量与无关元数据。
- **数据一致性维护**：采用 **Level-2：双端比对** 策略，维护 `chunk_checksum`（或 row count）快照表，定期比对两端数据。

#### 2.3.5.2 接口与数据流

- **对外接口**：无直接对外接口，作为后台服务自动运行。
- **对内接口**：
  - 调用 `SQLiteRepo` 查询元数据和快照表。
  - 调用 `QdrantRepo` 查询向量数据。
  - 执行删除操作以清理不一致数据。
- **数据流**：后台定时任务 -> AutoGC -> SQLiteRepo / QdrantRepo。

#### 2.3.5.3 关键实现与技术栈

- **双端比对**：实现 SQLite 和 Qdrant 数据的一致性检查逻辑。
- **定时任务**：使用 `node-cron` 或类似库实现定时执行。

#### 2.3.5.4 开发需求与约定

- **编码规范**：
  - 清理逻辑应严谨，避免误删数据。
  - 日志记录应详细，记录每次清理操作的结果。
- **错误处理**：
  - 在清理过程中捕获异常，并确保清理操作的幂等性。
- **测试策略**：
  - 对 `AutoGC` 进行集成测试，模拟数据不一致的场景，验证其清理功能的正确性。
  - 在测试环境中验证清理操作不会影响正常业务数据。
- **性能考量**：
  - 清理任务应在系统低峰期运行，避免对正常业务造成影响。
  - 优化数据比对和删除操作的效率。
